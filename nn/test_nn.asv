% test trained NN called 'net'

test_images_directory = 'D:\Ira\ML Project\denoising\data\train_tiny';
target_images_directory = 'D:\Ira\ML Project\denoising\data\train_tiny';
results_directory = 'D:\Ira\ML Project\denoising\data\predicted_small';

input_images = dir(sprintf('%s/*.png', test_images_directory));
image_count = length(input_images(not([input_images.isdir])));
rows = 258;
columns = 540;

block_s1 = 43;
block_s2 = 45;
block_size = block_s1*block_s2;

blocks_in_one_image = (rows/block_s1)*(columns/block_s2);
data_size = blocks_in_one_image * image_count;

for img = input_images'
    %x = zeros(block_size, data_size);

    % read image
    imdata = double(imread(sprintf('%s/%s', test_images_directory, img.name)));
    [rows, columns] = size(imdata);
       
    
    % split image into blocks
    blocks = reshape(imdata, [block_s1, rows/block_s1, block_s2, columns/block_s2]);
    [s1, s2, s3, s4] = size(blocks);
    
    index = 1;
     for row = 1 : s2
        for column = 1 : s4            
            block = blocks(:, row, :, column);

            feature_vector = create_feature_vector(block);
            
            x = zeros(block_size, data_size);
            x(:, index) = feature_vector;
            predicted = sim(net, x);
            res = predicted(:, index);
            blocks(:, row, :, column) = reshape(res, block_s1, block_s2); 
            
            %index = index + 1;
           
        end;
    end;
  
    % use net to predict 
    %predicted = sim(net, x);
    
%     index = 1;
%     for row = 1 : s2
%         for column = 1 : s4            
%             res = predicted(:, index);
%             blocks(:, row, :, column) = reshape(res, block_s1, block_s2); 
%             index = index + 1;
%         end;
%     end;

%     % convert net output back to image
%     parts = reshape(predicted, [s2, s4]);
%     for row = 1 : s2
%         for column = 1 : s4
%             parts{row, column} = reshape(cell2mat(parts(row, column)), [s1, s3]);
%         end;
%     end;
%     blocks = cell2mat(parts);

    img_matrix = uint8(round(reshape(blocks, rows, columns)));

    % write result
    imwrite(img_matrix, sprintf('%s/%s', results_directory, img.name));
    
    mseError = mse(X-XReconstructed)
end


